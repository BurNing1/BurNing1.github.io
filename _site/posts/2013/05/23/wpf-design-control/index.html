<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>使用WPF设计自定义控件</title>
    <meta name="description" content="The blog of professional experience in software, and my life are recorded bit by bit">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css" />
    <link rel="stylesheet" href="http://tommyknight.cn/css/main.css">
    <link rel="canonical" href="http://tommyknight.cn/posts/2013/05/23/wpf-design-control">
    <link rel="author" href="https://plus.google.com/106464408304855124012">
    <script type="text/javascript" src="http://tommyknight.cn/js/jquery.min.js"></script>
    <script src="http://tommyknight.cn/js/main.js"></script>
</head>


  <body>

    <section class="site-nav">
    <header>
        <nav id="navigation" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
            
                <a href="/">Home</a>
            
                <a href="/blog">Blog</a>
            
                <a href="/archive/">Archive</a>
            
                <a href="/about/">About</a>
            
        </nav>
    </header>
</section>

    <div class="page-content">
       <div class="post">
  <header class="post-header">
    <h1 class="post-title">使用WPF设计自定义控件</h1>
    <p class="post-meta">May 23, 2013</p>
  </header>

  <article class="post-content">
    <p>在实际工作中，WPF提供的控件并不能完全满足不同的设计需求。这时，需要我们设计自定义控件。</p>

<p>这里LZ总结一些自己的思路，特性如下：</p>

<ul>
  <li>
    <p>Coupling</p>
  </li>
  <li>
    <p>UITemplate</p>
  </li>
  <li>
    <p>Behaviour</p>
  </li>
  <li>
    <p>Function Package</p>

    <p>下面举例说说在项目中我们经常用到调音台音量条，写一个自定义控件模拟调音台音量条。
自定义控件SingnalLight,实现功能,如下：</p>
  </li>
  <li>
    <p>接收来自外部的范围0~100的数值</p>
  </li>
  <li>
    <p>实时显示接收数值</p>
  </li>
  <li>
    <p>数值范围0~50显示绿色，50~85显示黄色，85~100显示红色，没有数值显示褐色</p>
  </li>
  <li>
    <p>可在父控件上拖拽该控件</p>
  </li>
</ul>

<p>首先New WPF Application Project,在Ui上放2个Button,如下：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1     &lt;Grid&gt;
2         &lt;StackPanel Orientation=&quot;Horizontal&quot; VerticalAlignment=&quot;Bottom&quot;&gt;
3             &lt;Button Content=&quot;Start&quot; Click=&quot;Start_Click&quot;&gt;&lt;/Button&gt;
4             &lt;Button Content=&quot;Stop&quot; Click=&quot;Stop_Click&quot;&gt;&lt;/Button&gt;
5         &lt;/StackPanel&gt;
6     &lt;/Grid&gt;</code></pre></div>

<p>Start,Stop事件实现,如下:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1         private void Start_Click(object sender, RoutedEventArgs e) {
2             SignalManager.Instance.Start();
3         }
4
5         private void Stop_Click(object sender, RoutedEventArgs e) {
6             SignalManager.Instance.Stop();
7         }</code></pre></div>

<p>这里创建一个SignalManager类，在Start时开启一个计时器，每隔1秒生成一个0~100的随机数，并作为模拟数值输出。
SignalManager类代码：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1 namespace SignalLightDemo.Business {
 2     public class SignalManager : DependencyObject {
 3         public static SignalManager Instance { get { return instance; } }
 4
 5         public int RandomA {
 6             get { return (int)GetValue(RandomAProperty); }
 7             set { SetValue(RandomAProperty, value); }
 8         }
 9
10         SignalManager() {
11             InitializationTimer();
12         }
13
14         public void Start() {
15             if (!timerA.Enabled) timerA.Start();
16         }
17
18         public void Stop() {
19             if (timerA.Enabled) timerA.Stop();
20         }
21
22         private void InitializationTimer() {
23             timerA = new Timer();
24             timerA.Interval = INTERVAL;
25             timerA.Elapsed += timerA_Elapsed;
26         }
27
28         void timerA_Elapsed(object sender, ElapsedEventArgs e) {
29             this.Dispatcher.BeginInvoke(new Action(() =&gt; {
30                 RandomA = a.Next(MAX_VALUE);
31             }));
32         }
33
34         public static readonly DependencyProperty RandomAProperty =
35             DependencyProperty.Register(&quot;RandomA&quot;, typeof(int), typeof(SignalManager), new PropertyMetadata(0));
36
37         private Random a = new Random((int)DateTime.Now.Ticks);
38         private const int MAX_VALUE = 100;
39         private const double INTERVAL = 1000;
40         private Timer timerA;
41         private static SignalManager instance = new SignalManager();
42     }
43 }</code></pre></div>

<p>下面来重点：</p>

<ol>
  <li>创建自定义控件SingnalLight,ValueA为接受外部数值的属性,代码如下：</li>
</ol>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1     public class SingnalLight : ContentControl {
 2         public int ValueA {
 3             get { return (int)GetValue(ValueAProperty); }
 4             set { SetValue(ValueAProperty, value); }
 5         }
 6
 7
 8         public SingnalLight() {
 9             this.AllowDrop = true;
10         }
11
12
13         static SingnalLight() {
14             DefaultStyleKeyProperty.OverrideMetadata(typeof(SingnalLight), new FrameworkPropertyMetadata(typeof(SingnalLight)));
15         }
16
17
18     }</code></pre></div>

<p>2.复写控件UITemplate</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1  &lt;Style TargetType=&quot;{x:Type control:SingnalLight}&quot;&gt;
2         &lt;Setter Property=&quot;RenderTransform&quot;&gt;
3             &lt;Setter.Value&gt;
4                 &lt;TranslateTransform X=&quot;{Binding Path=X,RelativeSource={RelativeSource AncestorType={x:Type control:SingnalLight}}}&quot;
5                                     Y=&quot;{Binding Path=Y,RelativeSource={RelativeSource AncestorType={x:Type control:SingnalLight}}}&quot;/&gt;
6             &lt;/Setter.Value&gt;
7         &lt;/Setter&gt;
8         &lt;Setter Property=&quot;Template&quot;&gt;
9             &lt;Setter.Value&gt;
10                 &lt;ControlTemplate&gt;
11                     &lt;ControlTemplate.Resources&gt;
12                         &lt;control:SingnalLightStatusConverter x:Key=&quot;colorconverter&quot;&gt;&lt;/control:SingnalLightStatusConverter&gt;
13                         &lt;control:SingnalLightValueConverter x:Key=&quot;valueconverter&quot;&gt;&lt;/control:SingnalLightValueConverter&gt;
14                     &lt;/ControlTemplate.Resources&gt;
15                     &lt;StackPanel&gt;
16                         &lt;TextBlock Text=&quot;{Binding Path=ValueA,RelativeSource={RelativeSource AncestorType={x:Type control:SingnalLight}}}&quot;&gt;&lt;/TextBlock&gt;
17                         &lt;TextBlock Text=&quot;100&quot;&gt;&lt;/TextBlock&gt;
18                         &lt;Border
19                             x:Name=&quot;bd1&quot;
20                             Height=&quot;{Binding Path=LightHeight,RelativeSource={RelativeSource AncestorType={x:Type control:SingnalLight}}}&quot;
21                             SnapsToDevicePixels=&quot;True&quot;
22                             BorderBrush=&quot;Black&quot; BorderThickness=&quot;1&quot; Background=&quot;Transparent&quot;&gt;
23                             &lt;Rectangle Fill=&quot;{Binding Path=ValueA,
24                                                       RelativeSource={RelativeSource AncestorType={x:Type control:SingnalLight}},
25                                                       Converter={StaticResource ResourceKey=colorconverter}}&quot;
26                                        VerticalAlignment=&quot;Bottom&quot;&gt;
27                                 &lt;Rectangle.Height&gt;
28                                     &lt;MultiBinding Converter=&quot;{StaticResource ResourceKey=valueconverter}&quot;&gt;
29                                         &lt;Binding Path=&quot;ValueA&quot; RelativeSource=&quot;{RelativeSource AncestorType={x:Type control:SingnalLight}}&quot;&gt;&lt;/Binding&gt;
30                                         &lt;Binding Path=&quot;Height&quot; ElementName=&quot;bd1&quot;&gt;&lt;/Binding&gt;
31                                     &lt;/MultiBinding&gt;
32                                 &lt;/Rectangle.Height&gt;
33                             &lt;/Rectangle&gt;
34                         &lt;/Border&gt;
35                         &lt;TextBlock Text=&quot;0&quot;&gt;&lt;/TextBlock&gt;
36                     &lt;/StackPanel&gt;
37                 &lt;/ControlTemplate&gt;
38             &lt;/Setter.Value&gt;
39         &lt;/Setter&gt;
40     &lt;/Style&gt;</code></pre></div>

<p>3.接受值判断，SingnalLight通过实现IValueConverter和Override Arrange &amp; Measure Methods，实现了UI呈现的绑定：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1     public class SingnalLightStatusConverter : IValueConverter {
 2         public object Convert(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
 3             SolidColorBrush result = Brushes.Transparent;
 4             if (value.GetType() == typeof(int)) {
 5                 var color = System.Convert.ToInt32(value);
 6                 if (color &lt; 50) result = Brushes.Green;
 7                 else if (color &lt; 85 &amp;&amp; color &gt;= 50) result = Brushes.Yellow;
 8                 else if (color &lt;= 100 &amp;&amp; color &gt;= 85) result = Brushes.Red;
 9                 else result = Brushes.Gray;
10             }
11             return result;
12         }
13
14         public object ConvertBack(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
15             throw new NotImplementedException();
16         }
17     }
18
19     public class SingnalLightValueConverter : IMultiValueConverter {
20         public object Convert(object[] values, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
21             double result = 0;
22             if (values[0].GetType() == typeof(int) &amp;&amp; values[1].GetType() == typeof(double)) {
23                 result = (double)values[1] / 100 * System.Convert.ToDouble(values[0]);
24             }
25             return result;
26         }
27
28         public object[] ConvertBack(object value, Type[] targetTypes, object parameter, System.Globalization.CultureInfo culture) {
29             throw new NotImplementedException();
30         }
31     }</code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1         protected override Size MeasureOverride(Size constraint) {
2             if (ActualHeight &gt; 0) LightHeight = ActualHeight * .7;
3             return base.MeasureOverride(constraint);
4         }
5
6         protected override Size ArrangeOverride(Size arrangeBounds) {
7             return base.ArrangeOverride(arrangeBounds);
8         }</code></pre></div>

<p>4.控件支持拖拽，覆写MouseDown,MouseMove,MouseUp方法。这样写的好处是，如果在父控件的事件中实现Drag，父控件如果有多个对象，这样逻辑会十分混乱。</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1         protected override void OnMouseMove(MouseEventArgs e) {
 2             base.OnMouseMove(e);
 3             if (e.LeftButton == MouseButtonState.Pressed) {
 4                 _currentPoint = e.GetPosition(this);
 5                 X += _currentPoint.X - _startPoint.X;
 6                 Y += _currentPoint.Y - _startPoint.Y;
 7             }
 8         }
 9
10         protected override void OnMouseDown(MouseButtonEventArgs e) {
11             base.OnMouseDown(e);
12             _startPoint = e.GetPosition(this);
13             this.CaptureMouse();
14         }
15
16         protected override void OnMouseUp(MouseButtonEventArgs e) {
17             base.OnMouseUp(e);
18             this.ReleaseMouseCapture();
19         }</code></pre></div>

<p>SingnalLight完整代码：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1 using System;
  2 using System.Collections.Generic;
  3 using System.Linq;
  4 using System.Text;
  5 using System.Threading.Tasks;
  6 using System.Windows;
  7 using System.Windows.Controls;
  8 using System.Windows.Data;
  9 using System.Windows.Input;
 10 using System.Windows.Media;
 11
 12 namespace SignalLightDemo.Control {
 13     public class SingnalLight : ContentControl {
 14         public int ValueA {
 15             get { return (int)GetValue(ValueAProperty); }
 16             set { SetValue(ValueAProperty, value); }
 17         }
 18
 19         public double LightHeight {
 20             get { return (double)GetValue(LightHeightProperty); }
 21             set { SetValue(LightHeightProperty, value); }
 22         }
 23
 24         public double X {
 25             get { return (double)GetValue(XProperty); }
 26             set { SetValue(XProperty, value); }
 27         }
 28
 29         public double Y {
 30             get { return (double)GetValue(YProperty); }
 31             set { SetValue(YProperty, value); }
 32         }
 33
 34         public SingnalLight() {
 35             this.AllowDrop = true;
 36         }
 37
 38         protected override void OnMouseMove(MouseEventArgs e) {
 39             base.OnMouseMove(e);
 40             if (e.LeftButton == MouseButtonState.Pressed) {
 41                 _currentPoint = e.GetPosition(this);
 42                 X += _currentPoint.X - _startPoint.X;
 43                 Y += _currentPoint.Y - _startPoint.Y;
 44             }
 45         }
 46
 47         protected override void OnMouseDown(MouseButtonEventArgs e) {
 48             base.OnMouseDown(e);
 49             _startPoint = e.GetPosition(this);
 50             this.CaptureMouse();
 51         }
 52
 53         protected override void OnMouseUp(MouseButtonEventArgs e) {
 54             base.OnMouseUp(e);
 55             this.ReleaseMouseCapture();
 56         }
 57
 58         protected override Size MeasureOverride(Size constraint) {
 59             if (ActualHeight &gt; 0) LightHeight = ActualHeight * .7;
 60             return base.MeasureOverride(constraint);
 61         }
 62
 63         protected override Size ArrangeOverride(Size arrangeBounds) {
 64             return base.ArrangeOverride(arrangeBounds);
 65         }
 66
 67         static SingnalLight() {
 68             DefaultStyleKeyProperty.OverrideMetadata(typeof(SingnalLight), new FrameworkPropertyMetadata(typeof(SingnalLight)));
 69         }
 70
 71         public static readonly DependencyProperty LightHeightProperty =
 72             DependencyProperty.Register(&quot;LightHeight&quot;, typeof(double), typeof(SingnalLight), new PropertyMetadata((double)0));
 73
 74         public static readonly DependencyProperty ValueAProperty =
 75             DependencyProperty.Register(&quot;ValueA&quot;, typeof(int), typeof(SingnalLight), new PropertyMetadata(0));
 76
 77         public static readonly DependencyProperty XProperty =
 78             DependencyProperty.Register(&quot;X&quot;, typeof(double), typeof(SingnalLight), new PropertyMetadata((double)0));
 79
 80         public static readonly DependencyProperty YProperty =
 81             DependencyProperty.Register(&quot;Y&quot;, typeof(double), typeof(SingnalLight), new PropertyMetadata((double)0));
 82
 83         private Point _startPoint;
 84         private Point _currentPoint;
 85     }
 86
 87     public class SingnalLightStatusConverter : IValueConverter {
 88         public object Convert(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
 89             SolidColorBrush result = Brushes.Transparent;
 90             if (value.GetType() == typeof(int)) {
 91                 var color = System.Convert.ToInt32(value);
 92                 if (color &lt; 50) result = Brushes.Green;
 93                 else if (color &lt; 85 &amp;&amp; color &gt;= 50) result = Brushes.Yellow;
 94                 else if (color &lt;= 100 &amp;&amp; color &gt;= 85) result = Brushes.Red;
 95                 else result = Brushes.Gray;
 96             }
 97             return result;
 98         }
 99
100         public object ConvertBack(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
101             throw new NotImplementedException();
102         }
103     }
104
105     public class SingnalLightValueConverter : IMultiValueConverter {
106         public object Convert(object[] values, Type targetType, object parameter, System.Globalization.CultureInfo culture) {
107             double result = 0;
108             if (values[0].GetType() == typeof(int) &amp;&amp; values[1].GetType() == typeof(double)) {
109                 result = (double)values[1] / 100 * System.Convert.ToDouble(values[0]);
110             }
111             return result;
112         }
113
114         public object[] ConvertBack(object value, Type[] targetTypes, object parameter, System.Globalization.CultureInfo culture) {
115             throw new NotImplementedException();
116         }
117     }
118 }</code></pre></div>

<p>界面调用：</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">1 &lt;Window x:Class=&quot;SignalLightDemo.MainWindow&quot;
2         xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;
3         xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;
4         xmlns:control=&quot;clr-namespace:SignalLightDemo.Control&quot;
5         xmlns:business=&quot;clr-namespace:SignalLightDemo.Business&quot;
6         Title=&quot;SignalLight&quot; Height=&quot;600&quot; Width=&quot;800&quot;&gt;
7     &lt;Grid&gt;
8         &lt;control:SingnalLight Width=&quot;50&quot; Height=&quot;300&quot;
9                              ValueA=&quot;{Binding Source={x:Static business:SignalManager.Instance},Path=RandomA}&quot;&gt;&lt;/control:SingnalLight&gt;
10         &lt;StackPanel Orientation=&quot;Horizontal&quot; VerticalAlignment=&quot;Bottom&quot;&gt;
11             &lt;Button Content=&quot;Start&quot; Click=&quot;Start_Click&quot;&gt;&lt;/Button&gt;
12             &lt;Button Content=&quot;Stop&quot; Click=&quot;Stop_Click&quot;&gt;&lt;/Button&gt;
13         &lt;/StackPanel&gt;
14     &lt;/Grid&gt;
15 &lt;/Window&gt;</code></pre></div>


  </article>
</div>

    </div>

    <footer class="site-footer">
  <div class="wrapper">
      <p>
          <small>|&nbsp;Powered by
              <a href="https://github.com/mojombo/jekyll">Jekyll</a>&nbsp;|&nbsp;Copyright 2014 by
              <a href="http://tommyknight.cn/about/index.html">Tommy</a><br/><br/>|&nbsp;Contact me from&nbsp;&nbsp;
              <a href="https://twitter.com/tommywu23" title="@淘米侠 on Twitter" target="_blank">
                  <i class="icon icon-twitter black"></i>
              </a>
              <a href="https://www.facebook.com/jinsheng.wu.9" title="@淘米侠 on Facebook" target="_blank">
                  <i class="icon icon-facebook black"></i>
              </a>
              <a href="https://plus.google.com/106464408304855124012" title="@淘米侠 on Google" target="_blank">
                  <i class="icon icon-google black"></i>
              </a>
              <a href="http://www.linkedin.com/pub/tommy-wu/90/567/bb2/" title="@淘米侠 on LinkedIn" target="_blank">
                  <i class="icon icon-linkedin black"></i>
              </a>
              <a href="http://github/tommywu23" title="@淘米侠 on Github" target="_blank">
                  <i class="icon icon-github black"></i>
              </a>
              <a href="/feed.xml" title="RSS Feed" target="_blank">
                  <i class="icon icon-rss black"></i>
              </a>&nbsp;
          </small>
      </p>
  </div>

  <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-53906068-1', 'auto');
        ga('send', 'pageview');
    </script>
</footer>


  </body>

</html>
